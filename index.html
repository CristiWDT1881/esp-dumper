// DETECTARE FLASH SIZE - METODA PRECISĂ
                try {
                    const flashId = await state.esploader.flashId();
                    log(`Flash ID: 0x${flashId.toString(16).toUpperCase()}`, 'info');
                    
                    // Extrage size code din byte-ul potrivit
                    const sizeCode = (flashId >> 16) & 0xFF;
                    log(`Size code: 0x${sizeCode.toString(16).toUpperCase()}`, 'info');
                    
                    // Map precis pentru flash sizes
                    const flashSizesMap = {
                        0x12: 0.25, // 256KB
                        0x13: 0.5,  // 512KB
                        0x14: 1,    // 1MB
                        0x15: 2,    // 2MB
                        0x16: 4,    // 4MB
                        0x17: 8,    // 8MB
                        0x18: 16,   // 16MB
                        0x19: 32,   // 32MB
                        0x1A: 64,   // 64MB
                        0x1B: 128   // 128MB
                    };
                    
                    let detectedMB = flashSizesMap[sizeCode];
                    
                    // Dacă nu găsim size code, verifică și flash_size din chip
                    if (!detectedMB && state.chip.FLASH_SIZES) {
                        const chipFlashSize = Object.keys(state.chip.FLASH_SIZES)[0];
                        if (chipFlashSize) {
                            detectedMB = parseInt(chipFlashSize.replace('MB', ''));
                            log(`Using chip default: ${detectedMB}MB`, 'warning');
                        }
                    }
                    
                    // Fallback inteligent bazat pe chip type
                    if (!detectedMB) {
                        if (state.chipName.includes('ESP32-S3')) {
                            detectedMB = 8; // ESP32-S3 common: 8MB
                        } else if (state.chipName.includes('ESP32-S2')) {
                            detectedMB = 4; // ESP32-S2 common: 4MB
                        } else if (state.chipName.includes('ESP32-C3')) {
                            detectedMB = 4; // ESP32-C3 common: 4MB
                        } else {
                            detectedMB = 4; // ESP32 classic common: 4MB
                        }
                        log(`Using fallback for ${state.chipName}: ${detectedMB}MB`, 'warning');
                    }
                    
                    state.flashSize = detectedMB * 1024 * 1024;
                    log(`✓ Flash: ${detectedMB} MB (${state.flashSize} bytes)`, 'success');
                    
                } catch(e) {
                    // Fallback sigur
                    state.flashSize = 4 * 1024 * 1024;
                    log(`Flash detection failed, using safe 4MB default`, 'warning');
                }
