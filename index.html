<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP Universal Flash Dumper & Writer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Segoe UI', Arial, sans-serif;
background-color: #1a5f3f;
min-height: 100vh;
padding: 20px;
display: flex;
flex-direction: column;
align-items: center;
}
.header-images {
display: flex;
justify-content: space-between;
align-items: flex-start;
width: 100%;
max-width: 700px;
margin-bottom: 40px;
}
.header-images img {
max-width: 180px;
height: auto;
border-radius: 10px;
box-shadow: 0 4px 15px rgba(0,0,0,0.3);
border: 4px solid #5B9BD5;
}
.container { max-width: 700px; width: 100%; }
h1 {
color: #FFD700;
font-size: 2.5em;
text-align: center;
margin: 20px 0;
text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
.section {
background: #B3D9F2;
border-radius: 15px;
padding: 20px;
margin-bottom: 15px;
box-shadow: 0 8px 30px rgba(0,0,0,0.3);
border: 4px solid #5B9BD5;
}
.section.first-box {
display: flex;
gap: 20px;
align-items: flex-start;
padding: 10px 20px;
}
.section-content { flex: 1; }
.signature-img {
width: 130px;
height: auto;
border-radius: 10px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
border: 4px solid #5B9BD5;
}
.section h2 { color: #1a5f3f; font-size: 1.3em; margin-bottom: 10px; }
.section p { color: #000; font-size: 0.95em; margin-bottom: 5px; }
.control-group { margin-bottom: 10px; }
.control-group label { color: #1a5f3f; font-weight: bold; display: block; margin-bottom: 5px; }
select, input[type="file"] {
width: 100%;
padding: 8px;
border: 3px solid #5B9BD5;
border-radius: 8px;
background: white;
}
.button-group {
display: flex;
gap: 10px;
margin-top: 10px;
flex-wrap: wrap;
}
button {
flex: 1;
min-width: 180px;
padding: 12px;
font-size: 1.1em;
font-weight: bold;
border: none;
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}
.btn-connect { background: #1a5f3f; color: white; }
.btn-connect:hover { background: #145030; transform: translateY(-2px); }
.btn-disconnect { background: #6c757d; color: white; }
.btn-read, .btn-write { background: #5B9BD5; color: #000; }
.btn-read:hover, .btn-write:hover { background: #FFD700; transform: translateY(-2px); }
button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
.status {
background: white;
padding: 10px;
border-radius: 8px;
margin-bottom: 10px;
border: 3px solid #5B9BD5;
font-weight: 500;
}
.status.connected { border-color: #1a5f3f; background: #d4edda; }
.status.working { border-color: #FFD700; background: #fff3cd; }
.status.error { border-color: #dc3545; background: #f8d7da; }
.info-box {
background: white;
padding: 10px;
border-radius: 8px;
margin-top: 10px;
border: 3px solid #5B9BD5;
font-size: 0.9em;
}
.info-box strong { color: #1a5f3f; }
.progress-bar {
width: 100%;
height: 30px;
background: white;
border-radius: 8px;
border: 3px solid #5B9BD5;
overflow: hidden;
margin: 10px 0;
display: none;
}
.progress-bar.active { display: block; }
.progress-fill {
height: 100%;
background: linear-gradient(90deg, #1a5f3f, #5B9BD5);
width: 0%;
transition: width 0.3s;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
}
.log-container {
background: #1e1e1e;
color: #00ff00;
padding: 15px;
border-radius: 8px;
max-height: 400px;
overflow-y: auto;
font-family: 'Courier New', monospace;
font-size: 0.9em;
line-height: 1.6;
}
.log-entry { margin-bottom: 3px; }
.log-entry.error { color: #ff6b6b; }
.log-entry.success { color: #51cf66; }
.log-entry.warning { color: #ffd43b; }
.log-entry.info { color: #74c0fc; }
.file-progress-item {
background: white;
padding: 10px;
border-radius: 8px;
margin: 8px 0;
border: 3px solid #5B9BD5;
}
.file-progress-item .file-name {
font-weight: bold;
color: #1a5f3f;
margin-bottom: 5px;
}
.file-progress-item .mini-progress {
width: 100%;
height: 20px;
background: #e0e0e0;
border-radius: 5px;
overflow: hidden;
}
.file-progress-item .mini-progress-fill {
height: 100%;
background: linear-gradient(90deg, #1a5f3f, #5B9BD5);
width: 0%;
transition: width 0.3s;
text-align: center;
color: white;
font-size: 0.85em;
line-height: 20px;
}
.file-list-container {
max-height: 300px;
overflow-y: auto;
margin-top: 10px;
}
.warning-message {
background: #B3D9F2;
border: 4px solid #5B9BD5;
border-radius: 15px;
padding: 20px;
margin-bottom: 15px;
text-align: center;
font-weight: bold;
color: #1a5f3f;
line-height: 1.8;
box-shadow: 0 8px 30px rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<div class="header-images">
<img src="./palatiasi.png" alt="Palatul Culturii" onerror="this.style.display='none'">
<img src="./logo.png" alt="Logo" onerror="this.style.display='none'">
</div>
<div class="container">
<h1>ESP Universal Flash Dumper & Writer</h1>

<div class="warning-message">
Orice-ai face să te înveleşti!<br>
Whatever you do, cover yourself!<br>
!مهما فعلت، غط نفسك
</div>

<div class="section first-box">
<div class="section-content">
<h2>Connect Device</h2>
<div id="status" class="status">Status: Disconnected</div>
<div id="deviceInfo" class="info-box" style="display: none;">
<strong>Chip:</strong> <span id="chipType">-</span><br>
<strong>Flash Size:</strong> <span id="flashSize">-</span><br>
<strong>MAC Address:</strong> <span id="macAddress">-</span><br>
<strong>Features:</strong> <span id="chipFeatures">-</span>
</div>
<div class="control-group">
<label>Flash Size Override:</label>
<select id="flashSizeSelect">
<option value="auto">Auto Detect</option>
<option value="4">4 MB (Force)</option>
<option value="8">8 MB (Force)</option>
<option value="16">16 MB (Force)</option>
</select>
</div>
<div class="button-group">
<button id="connectBtn" class="btn-connect">CONNECT</button>
<button id="disconnectBtn" class="btn-disconnect" disabled>DISCONNECT</button>
</div>
</div>
<img src="./semnatura.png" alt="Signature" class="signature-img" onerror="this.style.display='none'">
</div>

<div class="section">
<h2>Happy Read - Dump Flash</h2>
<div class="button-group">
<button id="dumpBtn" class="btn-read" disabled>HAPPY READ</button>
</div>
<div id="dumpProgress" class="progress-bar">
<div id="dumpProgressFill" class="progress-fill">0%</div>
</div>
</div>

<div class="section">
<h2>Happy Safety Send Backup</h2>
<div class="control-group">
<label>Choose Files:</label>
<input type="file" id="backupFiles" multiple>
</div>
<div id="selectedFilesInfo" style="margin-top:10px; color:#1a5f3f; font-weight:bold;"></div>
<div class="button-group">
<button id="safetyBackupBtn" class="btn-write" disabled>HAPPY SAFETY SEND BACKUP</button>
</div>
<div id="fileListContainer" class="file-list-container"></div>
</div>

<div class="section">
<h2>Happy Write - Write Flash</h2>
<div class="control-group">
<label>Firmware File:</label>
<input type="file" id="writeFile" accept=".bin">
</div>
<div class="button-group">
<button id="writeBtn" class="btn-write" disabled>HAPPY WRITE</button>
</div>
<div id="writeProgress" class="progress-bar">
<div id="writeProgressFill" class="progress-fill">0%</div>
</div>
</div>

<div class="section">
<h2>Operation Log</h2>
<div id="logContainer" class="log-container">
<div class="log-entry info">System ready.</div>
</div>
</div>
</div>

<script type="module">
import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.4.5/bundle.js';

// === CONFIG ===
const WORKER_URL = 'https://shrill-sun-b40e.tehnicdti.workers.dev';
const BACKBLAZE = {
  keyId: '005334a4b31a9360000000007',
  applicationKey: 'K005ajOLwAiPaMGV1jqzcmWoCD+7xaE',
  bucketId: '1303149a14db53119aa90316',
  bucketName: 'githubwdt81',
  folder: 'Uploads'
};
const SAFETY_PASSWORD_HASH = 'e4f3a81dd311d8836b73b9918ec73c2f5070ab22deaacbd37c79c262168bef32';
const CHUNK_SIZE = 100 * 1024 * 1024;

// === STATE ===
const state = {
  port: null, esploader: null, transport: null, chip: null,
  connected: false, isOperating: false,
  detectedFlashSize: 4, flashSizeMode: 'auto',
  selectedFiles: [], smsCode: null, macAddress: 'UNKNOWN'
};

const el = {
  status: document.getElementById('status'),
  connectBtn: document.getElementById('connectBtn'),
  disconnectBtn: document.getElementById('disconnectBtn'),
  dumpBtn: document.getElementById('dumpBtn'),
  writeBtn: document.getElementById('writeBtn'),
  safetyBackupBtn: document.getElementById('safetyBackupBtn'),
  logContainer: document.getElementById('logContainer'),
  dumpProgress: document.getElementById('dumpProgress'),
  dumpProgressFill: document.getElementById('dumpProgressFill'),
  writeProgress: document.getElementById('writeProgress'),
  writeProgressFill: document.getElementById('writeProgressFill'),
  writeFile: document.getElementById('writeFile'),
  backupFiles: document.getElementById('backupFiles'),
  deviceInfo: document.getElementById('deviceInfo'),
  chipType: document.getElementById('chipType'),
  flashSize: document.getElementById('flashSize'),
  macAddress: document.getElementById('macAddress'),
  chipFeatures: document.getElementById('chipFeatures'),
  flashSizeSelect: document.getElementById('flashSizeSelect'),
  selectedFilesInfo: document.getElementById('selectedFilesInfo'),
  fileListContainer: document.getElementById('fileListContainer')
};

// === LOG ===
function log(msg, type = 'info') {
  const time = new Date().toLocaleTimeString('ro-RO');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  entry.textContent = `[${time}] ${msg}`;
  el.logContainer.appendChild(entry);
  el.logContainer.scrollTop = el.logContainer.scrollHeight;
}

// === DIALOGURI ===
function showPasswordDialog() {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10000;';
    overlay.innerHTML = `
      <form id="pwdForm" style="background:#B3D9F2;padding:30px;border-radius:15px;border:4px solid #5B9BD5;max-width:400px;width:90%;display:flex;flex-direction:column;gap:15px;">
        <h3 style="color:#1a5f3f;margin:0;text-align:center;">Enter Password</h3>
        <input type="password" id="pwdInput" style="padding:12px;font-size:1.1em;border:3px solid #5B9BD5;border-radius:8px;" placeholder="Password">
        <div style="display:flex;gap:10px;">
          <button type="submit" style="flex:1;padding:12px;background:#1a5f3f;color:white;border:none;border-radius:8px;font-weight:bold;">OK</button>
          <button type="button" id="cancelBtn" style="flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:bold;">Cancel</button>
        </div>
      </form>
    `;
    document.body.appendChild(overlay);
    const input = overlay.querySelector('#pwdInput');
    input.focus();
    overlay.querySelector('#pwdForm').onsubmit = e => { e.preventDefault(); document.body.removeChild(overlay); resolve(input.value); };
    overlay.querySelector('#cancelBtn').onclick = () => { document.body.removeChild(overlay); resolve(null); };
  });
}

function showPhoneDialog() {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10000;';
    overlay.innerHTML = `
      <form id="phoneForm" style="background:#B3D9F2;padding:30px;border-radius:15px;border:4px solid #5B9BD5;max-width:400px;width:90%;display:flex;flex-direction:column;gap:15px;">
        <h3 style="color:#1a5f3f;margin:0;text-align:center;">Enter Phone (+40...)</h3>
        <input type="tel" id="phoneInput" style="padding:12px;font-size:1.1em;border:3px solid #5B9BD5;border-radius:8px;" placeholder="+407xxxxxxxx">
        <div style="display:flex;gap:10px;">
          <button type="submit" style="flex:1;padding:12px;background:#1a5f3f;color:white;border:none;border-radius:8px;font-weight:bold;">Send SMS</button>
          <button type="button" id="cancelBtn" style="flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:bold;">Cancel</button>
        </div>
      </form>
    `;
    document.body.appendChild(overlay);
    const input = overlay.querySelector('#phoneInput');
    input.focus();
    overlay.querySelector('#phoneForm').onsubmit = e => { e.preventDefault(); document.body.removeChild(overlay); resolve(input.value.trim()); };
    overlay.querySelector('#cancelBtn').onclick = () => { document.body.removeChild(overlay); resolve(null); };
  });
}

function showCodeDialog() {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10000;';
    overlay.innerHTML = `
      <form id="codeForm" style="background:#B3D9F2;padding:30px;border-radius:15px;border:4px solid #5B9BD5;max-width:400px;width:90%;display:flex;flex-direction:column;gap:15px;">
        <h3 style="color:#1a5f3f;margin:0;text-align:center;">Enter 6-digit Code</h3>
        <input type="text" id="codeInput" maxlength="6" style="padding:12px;font-size:1.1em;border:3px solid #5B9BD5;border-radius:8px;text-align:center;letter-spacing:8px;font-weight:bold;" placeholder="------">
        <div style="display:flex;gap:10px;">
          <button type="submit" style="flex:1;padding:12px;background:#1a5f3f;color:white;border:none;border-radius:8px;font-weight:bold;">Verify</button>
          <button type="button" id="cancelBtn" style="flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:bold;">Cancel</button>
        </div>
      </form>
    `;
    document.body.appendChild(overlay);
    const input = overlay.querySelector('#codeInput');
    input.focus();
    overlay.querySelector('#codeForm').onsubmit = e => { e.preventDefault(); document.body.removeChild(overlay); resolve(input.value.trim()); };
    overlay.querySelector('#cancelBtn').onclick = () => { document.body.removeChild(overlay); resolve(null); };
  });
}

// === SMS ===
async function sendSMS(to, code) {
  log(`Sending SMS to ${to}...`, 'info');
  const resp = await fetch(WORKER_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'sendSMS',
      to, code,
      keyId: BACKBLAZE.keyId,
      applicationKey: BACKBLAZE.applicationKey
    })
  });
  if (!resp.ok) throw new Error(`SMS failed: ${await resp.text()}`);
  log('SMS sent!', 'success');
}

async function verifySMS() {
  const phone = await showPhoneDialog();
  if (!phone) throw new Error('Cancelled');
  if (!/^\+?\d{10,15}$/.test(phone)) throw new Error('Invalid phone');

  const code = Math.floor(100000 + Math.random() * 900000).toString();
  state.smsCode = code;
  await sendSMS(phone, code);

  const userCode = await showCodeDialog();
  if (!userCode) throw new Error('Cancelled');
  if (userCode !== code) throw new Error('Wrong code!');
  log('SMS verified!', 'success');
}

// === CONNECT ===
async function connect() {
  try {
    state.port = await navigator.serial.requestPort();
    state.transport = new Transport(state.port);
    state.esploader = new ESPLoader({ transport: state.transport, baudrate: 921600 });
    log('Connecting...', 'info');
    state.chip = await state.esploader.main();
    state.connected = true;

    const info = await state.esploader.chipInfo();
    state.macAddress = info.mac;
    state.detectedFlashSize = 4; // Simplified

    el.chipType.textContent = info.chip;
    el.macAddress.textContent = state.macAddress;
    el.flashSize.textContent = `${state.detectedFlashSize} MB`;
    el.deviceInfo.style.display = 'block';

    updateStatus('Connected!', 'connected');
    el.connectBtn.disabled = true;
    el.disconnectBtn.disabled = false;
    el.dumpBtn.disabled = el.writeBtn.disabled = el.safetyBackupBtn.disabled = false;
    log('Connected!', 'success');
  } catch (e) {
    log(`Error: ${e.message}`, 'error');
  }
}

function disconnect() {
  if (state.connected) {
    state.transport?.disconnect();
    state.port?.close();
    state.connected = false;
    updateStatus('Disconnected');
    el.connectBtn.disabled = false;
    el.disconnectBtn.disabled = true;
    el.dumpBtn.disabled = el.writeBtn.disabled = el.safetyBackupBtn.disabled = true;
  }
}

// === DUMP ===
async function dumpFlash() {
  if (!state.connected) return;
  const size = 4 * 1024 * 1024;
  const data = await state.esploader.readFlash(0, size);
  const blob = new Blob([data], { type: 'application/octet-stream' });
  const filename = `dump_${state.macAddress.replace(/:/g, '-')}_${new Date().toISOString().slice(0,10)}.bin`;
  saveAs(blob, filename);
  log('Dump saved!', 'success');
}

// === SAFETY BACKUP ===
async function safetyBackup() {
  if (state.selectedFiles.length === 0) return alert('Select files!');
  const pwd = await showPasswordDialog();
  if (!pwd || CryptoJS.SHA256(pwd).toString() !== SAFETY_PASSWORD_HASH) return alert('Wrong password!');

  try {
    await verifySMS();
    // Upload logic here (simplified for now)
    alert('Backup would start now...');
  } catch (e) {
    alert(e.message);
  }
}

// === EVENTS ===
el.connectBtn.onclick = connect;
el.disconnectBtn.onclick = disconnect;
el.dumpBtn.onclick = dumpFlash;
el.safetyBackupBtn.onclick = safetyBackup;
el.backupFiles.onchange = () => {
  state.selectedFiles = Array.from(el.backupFiles.files);
  el.selectedFilesInfo.textContent = `${state.selectedFiles.length} files selected`;
  el.safetyBackupBtn.disabled = !state.connected || state.selectedFiles.length === 0;
};

function updateStatus(msg, type = '') {
  el.status.textContent = msg;
  el.status.className = `status ${type}`;
}

log('Ready. Click CONNECT.', 'info');
</script>
</body>
</html>
