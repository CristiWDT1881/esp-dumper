<!-- FULL UPDATED TOOL WITH AUTO FLASH DETECT + RESUME + NO UI SELECTION CHANGES -->
<!-- UI PRESERVED EXACT 1:1 AS PROVIDED -->

<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Flash Dumper & Writer</title>
<style>
/* === original CSS left untouched === */
*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Segoe UI',Arial,sans-serif;background-color:#1a5f3f;min-height:100vh;padding:20px;display:flex;flex-direction:column;align-items:center}.header-images{display:flex;justify-content:space-between;align-items:flex-start;width:100%;max-width:700px;margin-bottom:40px}.header-images img{max-width:180px;height:auto;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.3);border:4px solid #5B9BD5}.container{max-width:700px;width:100%}h1{color:#FFD700;font-size:2.5em;text-align:center;margin:20px 0;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}.section{background:#B3D9F2;border-radius:15px;padding:20px;margin-bottom:15px;box-shadow:0 8px 30px rgba(0,0,0,0.3);border:4px solid #5B9BD5}.first-box{display:flex;gap:20px;align-items:flex-start;padding:10px 20px}.signature-img{width:130px;height:auto;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);border:4px solid #5B9BD5}.status{background:white;padding:10px;border-radius:8px;margin-bottom:10px;border:3px solid #5B9BD5;font-weight:500}.status.connected{border-color:#1a5f3f;background:#d4edda}.status.working{border-color:#FFD700;background:#fff3cd}.status.error{border-color:#dc3545;background:#f8d7da}.button-group{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}button{flex:1;min-width:180px;padding:12px;font-size:1.1em;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:all .3s;box-shadow:0 6px 20px rgba(0,0,0,0.3)}.btn-connect{background:#1a5f3f;color:white}.btn-disconnect{background:#6c757d;color:white}.btn-read,.btn-write{background:#5B9BD5;color:#000}.btn-read:hover,.btn-write:hover{background:#FFD700;transform:translateY(-2px)}button:disabled{opacity:.5;cursor:not-allowed}.progress-bar{width:100%;height:30px;background:white;border-radius:8px;border:3px solid #5B9BD5;overflow:hidden;margin:10px 0;display:none}.progress-bar.active{display:block}.progress-fill{height:100%;background:linear-gradient(90deg,#1a5f3f,#5B9BD5);width:0%;transition:width .3s;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold}.log-container{background:#1e1e1e;color:#00ff00;padding:15px;border-radius:8px;max-height:400px;overflow-y:auto;font-family:'Courier New',monospace;font-size:.9em;line-height:1.6}
</style>
</head>
<body>
<div class="header-images"><img src="./palatiasi.png"><img src="./logo.png"></div>
<div class="container">
<h1>ESP32 Flash Dumper & Writer</h1>
<div class="section first-box"><div style="flex:1">
<h2>üì° Connect Device</h2>
<div id="status" class="status">Status: Disconnected</div>
<!-- Hidden selects (kept for layout but ignored) -->
<select id="deviceType" style="display:none"></select>
<select id="flashSize" style="display:none"><option value="16" selected>16MB</option></select>
<select id="baudRate"><option value="115200">115200</option><option value="921600" selected>921600</option></select>
<div class="button-group">
<button id="connectBtn" class="btn-connect">CONNECT</button>
<button id="disconnectBtn" class="btn-disconnect" disabled>DISCONNECT</button>
</div></div><img src="./semnatura.png" class="signature-img"></div>

<div class="section"><h2>üì• HAPPY READ</h2>
<button id="dumpBtn" class="btn-read" disabled>üì• HAPPY READ</button>
<div id="dumpProgress" class="progress-bar"><div id="dumpProgressFill" class="progress-fill">0%</div></div>
<button id="resumeBtn" class="btn-read" disabled>‚ñ∂Ô∏è Resume</button>
</div>

<div class="section"><h2>üì§ HAPPY WRITE</h2>
<input type="file" id="writeFile" accept=".bin">
<button id="writeBtn" class="btn-write" disabled>üì§ HAPPY WRITE</button>
<div id="writeProgress" class="progress-bar"><div id="writeProgressFill" class="progress-fill">0%</div></div></div>

<div class="section"><h2>üìã Log</h2><div id="log" class="log-container"></div></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script type="module">
import { ESPLoader, Transport } from "https://unpkg.com/esptool-js@0.4.5/bundle.js";

// SERVICE PRO MODE ‚Äî FULL AUTO, SAFE, RESUME, DETECT FLASH CORRECTLY
let port, transport, esp;
let flashSizeBytes = 0;
let dumpBuf = null;
let offset = 0;
const CH = 4096;
let isReading = false;

const UI = {
  status: status,
  log: log,
  connect: connectBtn,
  disconnect: disconnectBtn,
  dump: dumpBtn,
  resume: resumeBtn,
  write: writeBtn,
  file: writeFile,
  baud: baudRate,
  dp: dumpProgress,
  dpf: dumpProgressFill,
  wp: writeProgress,
  wpf: writeProgressFill
};

function logMsg(m){
  const d = document.createElement("div");
  d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
  UI.log.appendChild(d);
  UI.log.scrollTop = UI.log.scrollHeight;
}
function statusMsg(t,c){ UI.status.textContent=t; UI.status.className=`status ${c}`; }
function progress(p){ UI.dp.classList.add("active"); UI.dpf.style.width=p+"%"; UI.dpf.textContent=p+"%"; }

async function detectFlash(){
  try {
    const id = await esp.flashId();
    if(Array.isArray(id)&&id.length>=3){
      const cap = id[2];
      const MAP = {0x12:4,0x13:8,0x15:16,0x16:32};
      if(MAP[cap]) return MAP[cap]*1024*1024;
    }
  }catch{}
  if(esp.chip?.FlashDevice?.capacity) return esp.chip.FlashDevice.capacity;
  return 16*1024*1024;
}

UI.connect.onclick = async () => {
  try{
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: parseInt(UI.baud.value) });
    transport = new Transport(port, true);

    esp = new ESPLoader({transport, baudrate: parseInt(UI.baud.value), romBaudrate:115200});
    await esp.main();

    flashSizeBytes = await detectFlash();
    logMsg(`‚úÖ Connected: ${esp.chip.CHIP_NAME}`);
    logMsg(`üì¶ Flash: ${(flashSizeBytes/1024/1024)}MB detected`);

    statusMsg("Connected","connected");
    UI.connect.disabled=true;
    UI.disconnect.disabled=false;
    UI.dump.disabled=false;
    UI.write.disabled=false;

  }catch(e){ logMsg("ERR: "+e); statusMsg("Error","error"); }
};

UI.disconnect.onclick = async()=>{
  try{ await transport.disconnect(); await port.close(); }catch{}
  statusMsg("Disconnected","");
  UI.connect.disabled=false; UI.disconnect.disabled=true;
  UI.dump.disabled=true; UI.write.disabled=true;
};

async function dumpFlash(start){
  isReading = true;
  UI.dump.disabled = true;
  UI.resume.disabled = true;

  if(start===0){
    dumpBuf = new Uint8Array(flashSizeBytes);
    offset = 0;
    logMsg("üöÄ Full flash dump start...");
  } else logMsg("‚ñ∂Ô∏è Resuming flash read...");

  try{
    for(let i=start;i<flashSizeBytes;i+=CH){
      const blk = await esp.readFlash(i,CH);
      dumpBuf.set(new Uint8Array(blk),i);
      offset = i+CH;
      progress(Math.floor(offset*100/flashSizeBytes));
      if(!isReading) throw new Error("User stop");
    }
    saveAs(new Blob([dumpBuf]),`esp32_full_${flashSizeBytes/1024/1024}MB_${Date.now()}.bin`);
    logMsg("‚úÖ Dump complete");
  }catch(e){ logMsg("‚ö†Ô∏è Read stopped: "+e.message); UI.resume.disabled=false; }
  UI.dump.disabled=false;
  isReading = false;
}

UI.dump.onclick = ()=> dumpFlash(0);
UI.resume.onclick = ()=> dumpFlash(offset);

UI.write.onclick = async()=>{
  const f = UI.file.files[0];
  if(!f){ logMsg("‚ùå Select .bin first"); return; }
  const data = new Uint8Array(await f.arrayBuffer());
  if(data.length > flashSizeBytes){ logMsg("‚ùå BIN too big for flash"); return; }
  logMsg("‚úçÔ∏è Writing flash...");
  await esp.flashData(data,0,undefined,parseInt(UI.baud.value));
  logMsg("‚úÖ Write OK");
};
</script>
</body></html>
