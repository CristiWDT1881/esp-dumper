<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Flash Dumper & Writer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
  // Variabile globale pentru module
  window.CryptoJS = null;
  window.ESPLoader = null;
  window.Transport = null;
  window.esptoolReady = false;

  // Încărcare CryptoJS
  function loadCryptoJS() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
      script.onload = () => { window.CryptoJS = window.CryptoJS; resolve(); };
      script.onerror = () => reject(new Error('CryptoJS load failed'));
      document.head.appendChild(script);
    });
  }

  // Încărcare esptool-js
  function loadEsptool() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.type = 'module';
      script.textContent = `
        import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.4.5/bundle.js';
        window.ESPLoader = ESPLoader;
        window.Transport = Transport;
        window.esptoolReady = true;
      `;
      script.onload = () => setTimeout(resolve, 100);
      script.onerror = () => reject(new Error('esptool-js load failed'));
      document.head.appendChild(script);
    });
  }
</script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Segoe UI', Arial, sans-serif;
background-color: #1a5f3f;
min-height: 100vh;
padding: 20px;
display: flex;
flex-direction: column;
align-items: center;
}
.header-images {
display: flex;
justify-content: space-between;
align-items: flex-start;
width: 100%;
max-width: 700px;
margin-bottom: 40px;
}
.header-images img {
max-width: 180px;
height: auto;
border-radius: 10px;
box-shadow: 0 4px 15px rgba(0,0,0,0.3);
border: 4px solid #5B9BD5;
}
.container { max-width: 700px; width: 100%; }
h1 {
color: #FFD700;
font-size: 2.5em;
text-align: center;
margin: 20px 0;
text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
.section {
background: #B3D9F2;
border-radius: 15px;
padding: 20px;
margin-bottom: 15px;
box-shadow: 0 8px 30px rgba(0,0,0,0.3);
border: 4px solid #5B9BD5;
}
.section.first-box {
display: flex;
gap: 20px;
align-items: flex-start;
padding: 10px 20px;
}
.section-content { flex: 1; }
.signature-img {
width: 130px;
height: auto;
border-radius: 10px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
border: 4px solid #5B9BD5;
}
.section h2 { color: #1a5f3f; font-size: 1.3em; margin-bottom: 10px; }
.section p { color: #000; font-size: 0.95em; margin-bottom: 5px; }
.control-group { margin-bottom: 10px; }
.control-group label { color: #1a5f3f; font-weight: bold; display: block; margin-bottom: 5px; }
select, input[type="file"] {
width: 100%;
padding: 8px;
border: 3px solid #5B9BD5;
border-radius: 8px;
background: white;
}
.button-group {
display: flex;
gap: 10px;
margin-top: 10px;
flex-wrap: wrap;
}
button {
flex: 1;
min-width: 180px;
padding: 12px;
font-size: 1.1em;
font-weight: bold;
border: none;
border-radius: 12px;
cursor: pointer;
transition: all 0.3s;
box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}
.btn-connect { background: #1a5f3f; color: white; }
.btn-connect:hover { background: #145030; transform: translateY(-2px); }
.btn-disconnect { background: #6c757d; color: white; }
.btn-read, .btn-write { background: #5B9BD5; color: #000; }
.btn-read:hover, .btn-write:hover { background: #FFD700; transform: translateY(-2px); }
button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
.status {
background: white;
padding: 10px;
border-radius: 8px;
margin-bottom: 10px;
border: 3px solid #5B9BD5;
font-weight: 500;
}
.status.connected { border-color: #1a5f3f; background: #d4edda; }
.status.working { border-color: #FFD700; background: #fff3cd; }
.status.error { border-color: #dc3545; background: #f8d7da; }
.info-box {
background: white;
padding: 10px;
border-radius: 8px;
margin-top: 10px;
border: 3px solid #5B9BD5;
font-size: 0.9em;
}
.info-box strong { color: #1a5f3f; }
.progress-bar {
width: 100%;
height: 30px;
background: white;
border-radius: 8px;
border: 3px solid #5B9BD5;
overflow: hidden;
margin: 10px 0;
display: none;
}
.progress-bar.active { display: block; }
.progress-fill {
height: 100%;
background: linear-gradient(90deg, #1a5f3f, #5B9BD5);
width: 0%;
transition: width 0.3s;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
}
.log-container {
background: #1e1e1e;
color: #00ff00;
padding: 15px;
border-radius: 8px;
max-height: 400px;
overflow-y: auto;
font-family: 'Courier New', monospace;
font-size: 0.9em;
line-height: 1.6;
}
.log-entry { margin-bottom: 3px; }
.log-entry.error { color: #ff6b6b; }
.log-entry.success { color: #51cf66; }
.log-entry.warning { color: #ffd43b; }
.log-entry.info { color: #74c0fc; }
.radio-links {
display: flex;
justify-content: space-around;
align-items: center;
gap: 30px;
flex-wrap: wrap;
}
.radio-link {
display: flex;
flex-direction: column;
align-items: center;
text-decoration: none;
transition: transform 0.3s;
}
.radio-link:hover { transform: scale(1.1); }
.radio-link img {
width: 120px;
height: 120px;
border-radius: 15px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
margin-bottom: 10px;
border: 4px solid #5B9BD5;
}
.radio-link span {
color: #000;
font-weight: bold;
font-size: 1.1em;
}
@media (max-width: 768px) {
.header-images { flex-direction: column; align-items: center; gap: 15px; }
h1 { font-size: 2em; }
}
</style>
</head>
<body>
<div class="header-images">
<img src="./palatiasi.png" alt="Palatul Culturii" onerror="this.style.display='none'">
<img src="./logo.png" alt="Logo" onerror="this.style.display='none'">
</div>

<div class="container">
<h1>ESP32 Flash Dumper & Writer</h1>

<div class="section first-box">
<div class="section-content">
<h2>Connect Device</h2>
<div id="status" class="status">Loading modules...</div>

<div id="deviceInfo" class="info-box" style="display: none;">
<strong>Chip:</strong> <span id="chipType">-</span><br>
<strong>Flash Size:</strong> <span id="flashSize">-</span><br>
<strong>MAC Address:</strong> <span id="macAddress">-</span>
</div>

<div class="control-group">
<label>Flash Size (MB):</label>
<select id="flashSizeSelect">
<option value="auto">Auto Detect</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="4">4</option>
<option value="8">8</option>
<option value="16">16</option>
<option value="32">32</option>
<option value="64">64</option>
</select>
</div>

<div class="button-group">
<button id="connectBtn" class="btn-connect" disabled>CONNECT</button>
<button id="disconnectBtn" class="btn-disconnect" disabled>DISCONNECT</button>
</div>
</div>
<img src="./semnatura.png" alt="Signature" class="signature-img" onerror="this.style.display='none'">
</div>

<div class="section">
<h2>Happy Read - Dump Flash</h2>
<p><strong>1.</strong> Connect device via USB</p>
<p><strong>2.</strong> Click HAPPY READ to dump entire flash</p>
<p><strong>3.</strong> File saved to Downloads</p>
<div class="button-group">
<button id="dumpBtn" class="btn-read" disabled>HAPPY READ</button>
</div>
<div id="dumpProgress" class="progress-bar">
<div id="dumpProgressFill" class="progress-fill">0%</div>
</div>
</div>

<div class="section">
<h2>Happy Safety Send Backup</h2>
<p><strong>1.</strong> Select file (.bin or ZIP)</p>
<p><strong>2.</strong> Enter password → GitHub sends SMS to +40764991929</p>
<p><strong>3.</strong> Enter code → upload to private Backblaze</p>
<div class="control-group">
<label>Select File:</label>
<input type="file" id="backupFile" accept=".bin,.zip">
</div>
<div class="button-group">
<button id="safetyBackupBtn" class="btn-write" disabled>HAPPY SAFETY SEND BACKUP</button>
</div>
<div id="safetyProgress" class="progress-bar">
<div id="safetyProgressFill" class="progress-fill">0%</div>
</div>
</div>

<div class="section">
<h2>Happy Write - Write Flash</h2>
<p><strong>1.</strong> Select firmware file (.bin)</p>
<p><strong>2.</strong> Click HAPPY WRITE</p>
<p><strong>3.</strong> System verifies compatibility (±25%)</p>
<div class="control-group">
<label>Select Firmware File:</label>
<input type="file" id="writeFile" accept=".bin">
</div>
<div class="button-group">
<button id="writeBtn" class="btn-write" disabled>HAPPY WRITE</button>
</div>
<div id="writeProgress" class="progress-bar">
<div id="writeProgressFill" class="progress-fill">0%</div>
</div>
</div>

<div class="section">
<h2>Operation Log</h2>
<div id="logContainer" class="log-container">
<div class="log-entry info">Initializing system...</div>
</div>
</div>

<div class="section">
<h2>Radio Live</h2>
<div class="radio-links">
<a href="https://www.radioromaniacultural.ro/live/" target="_blank" class="radio-link">
<img src="./logocultural.svg" alt="Radio România Cultural" onerror="this.style.display='none'">
<span>Cultural</span>
</a>
<a href="http://player.radioiasi.ro/live-radio-iasi.html" target="_blank" class="radio-link">
<img src="./logoriasi.svg" alt="Radio Iași" onerror="this.style.display='none'">
<span>Radio Iași</span>
</a>
</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // === REFERINȚE DOM ===
  const el = {
    status: document.getElementById('status'),
    connectBtn: document.getElementById('connectBtn'),
    disconnectBtn: document.getElementById('disconnectBtn'),
    dumpBtn: document.getElementById('dumpBtn'),
    writeBtn: document.getElementById('writeBtn'),
    safetyBackupBtn: document.getElementById('safetyBackupBtn'),
    logContainer: document.getElementById('logContainer'),
    dumpProgress: document.getElementById('dumpProgress'),
    dumpProgressFill: document.getElementById('dumpProgressFill'),
    safetyProgress: document.getElementById('safetyProgress'),
    safetyProgressFill: document.getElementById('safetyProgressFill'),
    backupFile: document.getElementById('backupFile'),
    deviceInfo: document.getElementById('deviceInfo'),
    chipType: document.getElementById('chipType'),
    flashSize: document.getElementById('flashSize'),
    macAddress: document.getElementById('macAddress'),
    flashSizeSelect: document.getElementById('flashSizeSelect')
  };

  // === LOG & STATUS ===
  function log(msg, type = 'info') {
    const time = new Date().toLocaleTimeString('ro-RO');
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${time}] ${msg}`;
    el.logContainer.appendChild(entry);
    el.logContainer.scrollTop = el.logContainer.scrollHeight;
  }

  function updateStatus(msg, type = '') {
    el.status.textContent = msg;
    el.status.className = `status ${type}`;
  }

  function updateProgress(bar, fill, pct, txt) {
    bar.classList.add('active');
    fill.style.width = pct + '%';
    fill.textContent = txt || pct + '%';
  }

  function hideProgress(bar) { bar.classList.remove('active'); }

  // === CONFIG ===
  const GITHUB_OAUTH_CLIENT_ID = 'Iv23li1EVQBLK849uJPr';
  const SAFETY_PASSWORD_HASH = '3f2a9c8b7d6e5f4a3b2c1d0e9f8a7b6c5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0';
  const BACKBLAZE = { /* ... același ca înainte ... */ };

  const state = { 
    port: null, esploader: null, transport: null, chip: null, connected: false, 
    isOperating: false, detectedFlashSize: 4, chipType: '', macAddress: '',
    flashSizeMode: 'auto', lastSelectedFile: null
  };

  // === PAROLA ===
  async function verifyPassword(input) {
    if (!window.CryptoJS) return false;
    const hash = window.CryptoJS.SHA256(input).toString();
    log(`Hash: ${hash}`, 'info');
    return hash === SAFETY_PASSWORD_HASH;
  }

  // === CONNECT ===
  async function connect() {
    if (!window.esptoolReady || !navigator.serial) {
      alert('Web Serial API not supported or modules not loaded!');
      return;
    }
    try {
      updateStatus('Requesting port...', 'working');
      log('Requesting serial port...', 'info');
      state.port = await navigator.serial.requestPort();
      state.transport = new window.Transport(state.port, true);
      state.esploader = new window.ESPLoader({ transport: state.transport, baudrate: 115200, romBaudrate: 115200, terminal: { writeLine: log, write: log, clean: () => {} } });
      state.chip = await state.esploader.main();
      state.connected = true;
      state.chipType = state.chip?.CHIP_NAME || 'ESP32';

      // MAC & Flash detect
      try {
        const macData = await state.esploader.readFlash(0x1000, 16);
        const macHex = Array.from(new Uint8Array(macData)).map(b => b.toString(16).padStart(2, '0')).join('');
        state.macAddress = macHex.match(/([0-9a-f]{12})/)[1].match(/.{2}/g).join(':').toUpperCase();
      } catch (e) { state.macAddress = 'Unknown'; }

      try {
        const flashId = await state.esploader.flashId();
        const code = (flashId >> 16) & 0xFF;
        const map = {0x14:1,0x15:2,0x16:4,0x17:8,0x18:16,0x19:32,0x1A:64};
        state.detectedFlashSize = map[code] || 4;
      } catch (e) { state.detectedFlashSize = 4; }

      el.chipType.textContent = state.chipType;
      el.macAddress.textContent = state.macAddress;
      el.flashSize.textContent = `${state.detectedFlashSize} MB (auto)`;
      el.deviceInfo.style.display = 'block';

      updateStatus(`Connected: ${state.chipType}`, 'connected');
      el.connectBtn.disabled = true; el.disconnectBtn.disabled = false;
      el.dumpBtn.disabled = el.writeBtn.disabled = false;
      el.safetyBackupBtn.disabled = !state.lastSelectedFile;
      log('CONNECTED!', 'success');
    } catch (e) {
      log(`Error: ${e.message}`, 'error');
      updateStatus('Connection failed', 'error');
    }
  }

  // === RESTUL FUNCȚIILOR (happyRead, happySafetySendBackup, etc.) ===
  // (le poți adăuga din versiunile anterioare)

  // === ÎNCĂRCARE MODULE + ACTIVARE BUTON ===
  try {
    await Promise.all([loadCryptoJS(), loadEsptool()]);
    log('All modules loaded!', 'success');
    updateStatus('Ready to connect', 'connected');
    el.connectBtn.disabled = false;  // AICI ERA PROBLEMA!
    log('CONNECT BUTTON ENABLED!', 'success');
  } catch (e) {
    log('Module load failed!', 'error');
    updateStatus('Failed to load', 'error');
  }

  // === EVENT LISTENERS ===
  el.connectBtn.onclick = connect;
  el.backupFile.onchange = e => {
    state.lastSelectedFile = e.target.files[0];
    el.safetyBackupBtn.disabled = !(state.lastSelectedFile && state.connected);
  };
});
</script>
</body>
</html>
