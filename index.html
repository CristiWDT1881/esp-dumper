<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Flash Tool</title>
    <script src="https://unpkg.com/esp-web-tools@10.0.1/dist/web/install-button.js?module" type="module"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
        }

        .logo {
            width: 80px;
            height: 80px;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .content {
            padding: 40px;
        }

        .status-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            min-height: 180px;
            transition: all 0.3s ease;
        }

        .status-box.expanded {
            min-height: 250px;
        }

        .status-box h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1em;
            color: #212529;
            font-weight: 600;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-info {
            border-left-color: #4a9eff;
        }

        .log-success {
            border-left-color: #4caf50;
            color: #a5d6a7;
        }

        .log-error {
            border-left-color: #f44336;
            color: #ef9a9a;
        }

        .log-warning {
            border-left-color: #ff9800;
            color: #ffcc80;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 25px;
            color: #666;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß ESP32 Flash Tool</h1>
            <p>Professional Backup & Restore Solution</p>
            <div class="logo-container">
                <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="10" y="30" width="80" height="40" rx="5" fill="white" opacity="0.9"/>
                    <circle cx="30" cy="50" r="8" fill="#667eea"/>
                    <circle cx="50" cy="50" r="8" fill="#764ba2"/>
                    <circle cx="70" cy="50" r="8" fill="#667eea"/>
                    <path d="M 20 20 L 50 10 L 80 20" stroke="white" stroke-width="3" fill="none"/>
                    <path d="M 20 80 L 50 90 L 80 80" stroke="white" stroke-width="3" fill="none"/>
                </svg>
                <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="40" fill="white" opacity="0.9"/>
                    <path d="M 50 20 L 50 80 M 30 35 L 50 20 L 70 35 M 30 65 L 50 80 L 70 65" 
                          stroke="#667eea" stroke-width="4" fill="none" stroke-linecap="round"/>
                </svg>
            </div>
        </div>

        <div class="content">
            <div class="status-box" id="statusBox">
                <h3>üì° Device Status</h3>
                <div id="deviceInfo">
                    <p style="color: #6c757d;">No device connected. Click "Connect ESP32" to start.</p>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="connectBtn" onclick="connectDevice()">
                    üîå Connect ESP32
                </button>
                <button class="btn btn-success" id="readBtn" onclick="showReadConfirm()" disabled>
                    üì• Happy READ
                </button>
                <button class="btn btn-warning" id="writeBtn" onclick="showWriteConfirm()" disabled>
                    üì§ Happy WRITE
                </button>
                <button class="btn btn-danger" id="eraseBtn" onclick="eraseFlash()" disabled>
                    üóëÔ∏è Erase Flash
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">üìã Ready to connect ESP32 device...</div>
            </div>
        </div>
    </div>

    <!-- Modal pentru confirmare READ -->
    <div class="modal" id="readModal">
        <div class="modal-content">
            <div class="modal-header">üì• Happy READ?</div>
            <div class="modal-body" id="readModalBody">
                Do you want to read the entire flash memory?<br>
                The backup will be saved automatically to Downloads.
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeModal('readModal')">Cancel</button>
                <button class="btn btn-success" onclick="startRead()">Yes, Read!</button>
            </div>
        </div>
    </div>

    <!-- Modal pentru confirmare WRITE -->
    <div class="modal" id="writeModal">
        <div class="modal-content">
            <div class="modal-header">üì§ Happy WRITE?</div>
            <div class="modal-body">
                <p>Select a .bin file to write to the ESP32 flash.</p>
                <p style="color: #f5576c; margin-top: 10px;">‚ö†Ô∏è This will overwrite all existing data!</p>
                <input type="file" id="fileInput" accept=".bin" onchange="handleFileSelect(event)">
                <label for="fileInput" class="file-input-label" style="margin-top: 15px; display: block; text-align: center;">
                    üìÅ Choose File
                </label>
                <div id="fileInfo" style="margin-top: 15px; display: none;">
                    <p><strong>File:</strong> <span id="fileName"></span></p>
                    <p><strong>Size:</strong> <span id="fileSize"></span></p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeModal('writeModal')">Cancel</button>
                <button class="btn btn-success" id="writeConfirmBtn" onclick="startWrite()" disabled>Write!</button>
            </div>
        </div>
    </div>

    <script src="FileSaver.js"></script>
    <script type="module">
        import { ESPLoader, Transport } from "https://unpkg.com/esptool-js@0.4.0/bundle.js";

        let esploader;
        let transport;
        let chip = null;
        let currentFlashSize = 0;
        let chipModel = "";
        let macAddress = "";
        let selectedFile = null;

        window.connectDevice = async function() {
            try {
                addLog('üîå Requesting device access...', 'info');
                
                const device = await navigator.serial.requestPort({});
                transport = new Transport(device, true);
                
                addLog('‚ö° Connecting to device...', 'info');
                esploader = new ESPLoader({
                    transport: transport,
                    baudrate: 115200,
                    romBaudrate: 115200,
                    enableTracing: false
                });

                chip = await esploader.main();
                
                // Detectare informa»õii chip
                chipModel = chip.getChipDescription();
                macAddress = chip.macAddr();
                
                addLog(`‚úÖ Connected: ${chipModel}`, 'success');
                addLog(`üìç MAC Address: ${macAddress}`, 'info');

                // Detectare dimensiune flash
                const flashId = await esploader.flashId();
                currentFlashSize = esploader.flashSize;
                const flashSizeMB = (currentFlashSize / (1024 * 1024)).toFixed(0);
                
                addLog(`üíæ Flash Size: ${flashSizeMB}MB (${currentFlashSize} bytes)`, 'success');

                // Actualizare UI
                updateDeviceInfo(chipModel, macAddress, flashSizeMB, currentFlashSize);
                document.getElementById('statusBox').classList.add('expanded');
                
                // Activare butoane
                document.getElementById('readBtn').disabled = false;
                document.getElementById('writeBtn').disabled = false;
                document.getElementById('eraseBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;

            } catch (error) {
                addLog(`‚ùå Connection error: ${error.message}`, 'error');
            }
        };

        window.showReadConfirm = function() {
            const flashSizeMB = (currentFlashSize / (1024 * 1024)).toFixed(0);
            document.getElementById('readModalBody').innerHTML = `
                Do you want to read the entire flash memory?<br>
                <strong>Flash Size:</strong> ${flashSizeMB}MB (${currentFlashSize} bytes)<br>
                The backup will be saved automatically to Downloads.
            `;
            document.getElementById('readModal').classList.add('show');
        };

        window.startRead = async function() {
            closeModal('readModal');
            
            try {
                addLog('üì• Starting flash read...', 'info');
                showProgress(true);

                const flashData = new Uint8Array(currentFlashSize);
                const blockSize = 4096;
                const totalBlocks = Math.ceil(currentFlashSize / blockSize);

                for (let i = 0; i < totalBlocks; i++) {
                    const offset = i * blockSize;
                    const size = Math.min(blockSize, currentFlashSize - offset);
                    
                    const block = await esploader.readFlash(offset, size);
                    flashData.set(block, offset);

                    const progress = Math.round((i + 1) / totalBlocks * 100);
                    updateProgress(progress);
                    
                    if (i % 100 === 0) {
                        addLog(`üìñ Reading: ${progress}% (${(offset / 1024 / 1024).toFixed(2)}MB/${(currentFlashSize / 1024 / 1024).toFixed(0)}MB)`, 'info');
                    }
                }

                // Salvare automatƒÉ √Æn Downloads
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const macClean = macAddress.replace(/:/g, '-');
                const flashSizeMB = (currentFlashSize / (1024 * 1024)).toFixed(0);
                const filename = `ESP32-${chipModel}_${macClean}_${flashSizeMB}MB_${timestamp}.bin`;

                const blob = new Blob([flashData], { type: 'application/octet-stream' });
                saveAs(blob, filename);

                addLog(`‚úÖ Read complete! Saved as: ${filename}`, 'success');
                addLog(`üíæ File saved to Downloads folder`, 'success');
                showProgress(false);

            } catch (error) {
                addLog(`‚ùå Read error: ${error.message}`, 'error');
                showProgress(false);
            }
        };

        window.showWriteConfirm = function() {
            document.getElementById('writeModal').classList.add('show');
            selectedFile = null;
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('writeConfirmBtn').disabled = true;
        };

        window.handleFileSelect = function(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                const fileSizeMB = (selectedFile.size / (1024 * 1024)).toFixed(2);
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('fileSize').textContent = `${fileSizeMB}MB (${selectedFile.size} bytes)`;
                document.getElementById('fileInfo').style.display = 'block';
                
                // Verificare compatibilitate ¬±25%
                const minSize = currentFlashSize * 0.75;
                const maxSize = currentFlashSize * 1.25;
                const isCompatible = selectedFile.size >= minSize && selectedFile.size <= maxSize;
                
                if (isCompatible) {
                    const diff = Math.abs(selectedFile.size - currentFlashSize);
                    const diffPercent = ((diff / currentFlashSize) * 100).toFixed(1);
                    addLog(`‚úÖ File compatible! Difference: ${diffPercent}%`, 'success');
                    document.getElementById('writeConfirmBtn').disabled = false;
                } else {
                    const diff = Math.abs(selectedFile.size - currentFlashSize);
                    const diffPercent = ((diff / currentFlashSize) * 100).toFixed(1);
                    addLog(`‚ùå File NOT compatible! Difference: ${diffPercent}% (limit: ¬±25%)`, 'error');
                    document.getElementById('writeConfirmBtn').disabled = true;
                }
            }
        };

        window.startWrite = async function() {
            closeModal('writeModal');

            try {
                addLog('üì§ Starting flash write...', 'info');
                showProgress(true);

                const fileData = await selectedFile.arrayBuffer();
                const dataArray = new Uint8Array(fileData);

                addLog(`üìù Writing ${selectedFile.name} (${(dataArray.length / 1024 / 1024).toFixed(2)}MB)...`, 'info');

                await esploader.writeFlash({
                    fileArray: [{data: dataArray, address: 0x0}],
                    flashSize: "keep",
                    eraseAll: false,
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        const progress = Math.round((written / total) * 100);
                        updateProgress(progress);
                        if (written % (1024 * 1024) === 0 || written === total) {
                            addLog(`‚úçÔ∏è Writing: ${progress}% (${(written / 1024 / 1024).toFixed(2)}MB/${(total / 1024 / 1024).toFixed(2)}MB)`, 'info');
                        }
                    }
                });

                addLog('‚úÖ Write complete!', 'success');
                addLog('üîÑ Resetting device...', 'info');
                await esploader.hardReset();
                
                showProgress(false);

            } catch (error) {
                addLog(`‚ùå Write error: ${error.message}`, 'error');
                showProgress(false);
            }
        };

        window.eraseFlash = async function() {
            if (!confirm('‚ö†Ô∏è Are you sure? This will erase ALL data from the flash!')) {
                return;
            }

            try {
                addLog('üóëÔ∏è Erasing flash...', 'warning');
                showProgress(true);
                updateProgress(50);

                await esploader.eraseFlash();

                addLog('‚úÖ Flash erased successfully!', 'success');
                showProgress(false);

            } catch (error) {
                addLog(`‚ùå Erase error: ${error.message}`, 'error');
                showProgress(false);
            }
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        };

        function updateDeviceInfo(chip, mac, flashMB, flashBytes) {
            document.getElementById('deviceInfo').innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Chip Model</div>
                        <div class="info-value">${chip}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">MAC Address</div>
                        <div class="info-value">${mac}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Flash Size</div>
                        <div class="info-value">${flashMB}MB</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Flash Bytes</div>
                        <div class="info-value">${flashBytes.toLocaleString()}</div>
                    </div>
                </div>
            `;
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showProgress(show) {
            document.getElementById('progressContainer').style.display = show ? 'block' : 'none';
            if (!show) updateProgress(0);
        }

        function updateProgress(percent) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
        }

        // Expunere globalƒÉ
        window.esploader = esploader;
        window.addLog = addLog;
    </script>
</body>
</html>
